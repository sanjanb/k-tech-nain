# V9 QR Payment - Deployment Checklist

## üöÄ Pre-Deployment Checklist

### Code Quality ‚úÖ
- [x] No linting errors
- [x] No TypeScript errors
- [x] All files properly formatted
- [x] Import statements correct
- [x] No console.log in production code
- [x] Error handling in place

### Firebase Configuration ‚ö†Ô∏è (Verify Before Deploy)
- [ ] **Firebase Storage Rules** - Ensure QR uploads allowed:
  ```javascript
  rules_version = '2';
  service firebase.storage {
    match /b/{bucket}/o {
      match /qr-codes/{userId}/{fileName} {
        // Allow authenticated users to upload their own QR codes
        allow write: if request.auth != null && request.auth.uid == userId;
        // Allow anyone to read QR codes (public)
        allow read: if true;
      }
    }
  }
  ```

- [ ] **Firestore Rules** - Ensure user updates allowed:
  ```javascript
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      match /users/{userId} {
        allow read: if true;
        allow write: if request.auth != null && request.auth.uid == userId;
      }
    }
  }
  ```

- [ ] **Storage Bucket** - Verify storage enabled in Firebase Console
- [ ] **Storage Quota** - Check available storage space

### Environment Variables ‚úÖ
- [x] `NEXT_PUBLIC_FIREBASE_API_KEY` - Present
- [x] `NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN` - Present
- [x] `NEXT_PUBLIC_FIREBASE_PROJECT_ID` - Present
- [x] `NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET` - Present
- [x] `NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID` - Present
- [x] `NEXT_PUBLIC_FIREBASE_APP_ID` - Present

### Testing Requirements
- [ ] Test with real Firebase project (not emulator)
- [ ] Test QR upload with actual image
- [ ] Test UPI validation with various inputs
- [ ] Test on mobile device (responsive)
- [ ] Test with existing farmer accounts
- [ ] Test buyer flow end-to-end

---

## üìã Deployment Steps

### Step 1: Verify Firebase Setup
```bash
# Check Firebase project
firebase projects:list

# Verify current project
firebase use --add
```

### Step 2: Update Firestore Rules
```bash
# Deploy Firestore rules
firebase deploy --only firestore:rules
```

### Step 3: Update Storage Rules
```bash
# Deploy Storage rules
firebase deploy --only storage
```

### Step 4: Build & Test Locally
```bash
# Install dependencies
npm install

# Build the project
npm run build

# Test production build locally
npm run start
```

### Step 5: Deploy to Vercel/Hosting
```bash
# If using Vercel
vercel --prod

# If using Firebase Hosting
firebase deploy --only hosting
```

---

## üîç Post-Deployment Verification

### Immediate Checks (Within 5 minutes)
- [ ] Site loads without errors
- [ ] Navigation works
- [ ] Can access profile page
- [ ] Firebase connection successful
- [ ] No console errors

### Farmer Flow Tests (15 minutes)
- [ ] Login as farmer
- [ ] Navigate to profile
- [ ] See "Payment Details (Optional)" section
- [ ] Enable QR payment
- [ ] Upload test QR image (< 2MB PNG)
- [ ] Enter valid UPI ID: `test@paytm`
- [ ] Save successfully
- [ ] View own product
- [ ] Confirm QR section appears

### Buyer Flow Tests (10 minutes)
- [ ] Login as buyer
- [ ] Browse products
- [ ] Click product with farmer QR
- [ ] See QR code displayed
- [ ] Copy UPI ID works
- [ ] Click product without farmer QR
- [ ] See fallback message
- [ ] Express Interest works in both cases

### Edge Cases (10 minutes)
- [ ] Try invalid UPI: `noatsign` ‚Üí Error shown
- [ ] Try uploading PDF ‚Üí Error shown
- [ ] Try 3MB image ‚Üí Error shown
- [ ] Disable payment ‚Üí Confirmation asked
- [ ] Remove payment ‚Üí Data cleared
- [ ] Create new farmer account ‚Üí No payment required

---

## üêõ Rollback Plan

### If Critical Issues Found:

#### Option 1: Quick Fix
1. Identify the issue
2. Fix in code
3. Redeploy immediately

#### Option 2: Feature Toggle (Recommended)
Add to `.env`:
```env
NEXT_PUBLIC_ENABLE_QR_PAYMENT=false
```

Then wrap feature in profile:
```javascript
{process.env.NEXT_PUBLIC_ENABLE_QR_PAYMENT !== 'false' && userData.role === "farmer" && (
  // Payment section
)}
```

#### Option 3: Full Rollback
```bash
# Revert to previous commit
git revert HEAD
git push origin main

# Redeploy
vercel --prod
```

---

## üìä Monitoring After Deployment

### Day 1 - Critical Monitoring
- [ ] Check error logs hourly
- [ ] Monitor Firebase Storage usage
- [ ] Monitor Firestore read/write operations
- [ ] Check user feedback/support tickets
- [ ] Verify no payment-related confusion

### Week 1 - Active Monitoring
- [ ] Daily error log review
- [ ] Track QR upload success rate
- [ ] Monitor storage costs
- [ ] Collect user feedback
- [ ] Document any issues

### Month 1 - Usage Analytics
- [ ] % farmers using QR payment
- [ ] QR upload success vs failure rate
- [ ] Average QR file size
- [ ] User feedback summary
- [ ] Feature adoption rate

---

## üíæ Database Migration (If Needed)

### If Old Products Have product.upiId:

Option 1: Leave as-is (they still work, just don't display)
Option 2: Migrate to farmer profile:

```javascript
// Migration script (run once)
const migrateUpiToFarmers = async () => {
  const products = await getDocs(collection(db, "products"));
  
  for (const productDoc of products.docs) {
    const product = productDoc.data();
    if (product.upiId && product.farmerId) {
      // Update farmer profile
      const farmerRef = doc(db, "users", product.farmerId);
      const farmerSnap = await getDoc(farmerRef);
      
      if (farmerSnap.exists() && !farmerSnap.data().upiId) {
        await updateDoc(farmerRef, {
          upiId: product.upiId
        });
        console.log(`Migrated UPI for farmer ${product.farmerId}`);
      }
    }
  }
};
```

---

## üîê Security Checklist

- [x] **Input Validation** - UPI format validated
- [x] **File Validation** - Type and size checked
- [x] **Auth Required** - Only authenticated users upload
- [x] **User Ownership** - Can only edit own payment
- [x] **No XSS** - All user input sanitized
- [x] **No SQL Injection** - N/A (using Firestore)
- [ ] **Rate Limiting** - Consider adding for uploads
- [ ] **CORS** - Verify Firebase Storage CORS settings

---

## üìà Success Metrics

### Technical Metrics:
- **Upload Success Rate**: > 95%
- **Page Load Time**: < 3s
- **Error Rate**: < 1%
- **Storage Costs**: Within budget

### Business Metrics:
- **QR Adoption Rate**: Track % farmers enabling
- **Buyer Engagement**: Track views of QR section
- **Support Tickets**: Should not increase
- **User Feedback**: Should be positive

### Target Goals (Month 1):
- [ ] 20% farmers enable QR payment
- [ ] Zero payment-related complaints
- [ ] < 5 support tickets about QR
- [ ] No security incidents

---

## üìû Support Preparedness

### Common Issues & Solutions:

**"I can't upload my QR code"**
- Check file type (must be PNG/JPEG)
- Check file size (must be < 2MB)
- Try different browser
- Clear cache and retry

**"My UPI ID shows an error"**
- Format must be: username@bank
- Example: farmer123@paytm
- No spaces allowed
- Minimum 5 characters

**"Buyers can't see my QR"**
- Ensure "Enable QR Payment" is checked
- Save payment details in profile
- Verify QR image uploaded successfully
- Ask buyer to refresh page

**"I want to remove my payment details"**
- Go to Profile
- Uncheck "Enable QR Payment"
- Confirm removal
- Click Save

---

## üéØ Launch Communication

### User Announcement Template:

**Subject**: New Feature: Optional QR Payment for Farmers üéâ

**Body**:
```
Dear Farmers,

We're excited to announce a new optional feature to help you receive payments more easily!

‚ú® What's New:
- Add your UPI payment details to your profile
- Upload a QR code for buyers to scan
- Completely optional - use it if you want!

üìç How to Set Up:
1. Go to your Profile page
2. Find "Payment Details (Optional)"
3. Enable QR Payment
4. Add your UPI ID and/or upload QR code
5. Save!

Your QR code will appear on all your products for buyers to use.

‚ùó Important:
- This is completely optional
- Payments still go directly to you
- The platform does not process payments
- You can add or remove this anytime

Questions? Contact support@farmtotable.com

Happy farming! üåæ
```

---

## ‚úÖ Final Pre-Launch Checklist

**Code & Build:**
- [x] All code changes committed
- [x] No debug code remaining
- [ ] Build succeeds locally
- [ ] Production build tested

**Firebase:**
- [ ] Storage rules deployed
- [ ] Firestore rules deployed
- [ ] Storage bucket verified
- [ ] Quota checked

**Testing:**
- [ ] Manual testing complete
- [ ] All user flows tested
- [ ] Mobile responsive verified
- [ ] Cross-browser tested (Chrome, Safari, Firefox)

**Documentation:**
- [x] Implementation summary created
- [x] Testing guide created
- [x] Requirements checklist created
- [x] Flow diagrams created
- [x] Deployment checklist created (this file)

**Communication:**
- [ ] Support team briefed
- [ ] FAQ updated
- [ ] User announcement prepared
- [ ] Rollback plan ready

**Monitoring:**
- [ ] Error tracking configured
- [ ] Analytics events set up (optional)
- [ ] Alert thresholds defined
- [ ] Monitoring dashboard ready

---

## üöÄ Go / No-Go Decision

### GO Criteria (All must be YES):
- [ ] All tests passing
- [ ] No critical bugs
- [ ] Firebase configured correctly
- [ ] Rollback plan in place
- [ ] Support team ready
- [ ] Monitoring configured

### NO-GO Triggers:
- ‚ùå Storage upload fails
- ‚ùå UPI validation broken
- ‚ùå Existing flows broken
- ‚ùå Security concerns
- ‚ùå Performance issues

---

## üìÖ Deployment Schedule (Recommended)

**Best Time to Deploy:**
- ‚úÖ Tuesday-Thursday (mid-week)
- ‚úÖ Morning (9-11 AM local time)
- ‚úÖ Low traffic period
- ‚úÖ Team available for monitoring

**Avoid Deploying:**
- ‚ùå Friday afternoon (weekend monitoring risk)
- ‚ùå Monday morning (high traffic)
- ‚ùå During major sales/events
- ‚ùå When team is unavailable

---

## üéâ You're Ready to Deploy!

Once all checkboxes are complete:
1. ‚úÖ Review this checklist one more time
2. ‚úÖ Get approval from stakeholders
3. ‚úÖ Execute deployment steps
4. ‚úÖ Monitor for first 24 hours
5. ‚úÖ Celebrate success! üéä

**Good luck with your deployment!** üöÄ
